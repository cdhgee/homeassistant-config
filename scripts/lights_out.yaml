alias: Lights out

sequence:
  - service: input_boolean.turn_on
    target:
      entity_id: input_boolean.nighttime_mode
  - service: input_boolean.turn_off
    target:
      entity_id: input_boolean.babysitter_mode
  - service: light.turn_off
    target:
      entity_id: >
        {%
          set exclusions = expand("light.lights_out_exclusions")
          | map(attribute = "entity_id")
          | list
        %}
        {{
          expand(states.light)
          | rejectattr("entity_id", "in", exclusions)
          | rejectattr("attributes.entity_id", "defined")
          | map(attribute = "entity_id")
          | list
        }}
